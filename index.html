<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>ã‚¬ãƒ©ã‚¬ãƒ©ç¦å¼•ãï½œiPad è½‰æŠŠæ‰‹ç‰ˆ</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#f6f7fb;
    --ink:#101418;
    --sub:#66707a;
    --card:#fff;
    --shadow:0 10px 30px rgba(0,0,0,.10);
    --radius:22px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "Segoe UI", Roboto;
    background: radial-gradient(1200px 800px at 70% -10%, #fff, var(--bg));
    color:var(--ink);
    overscroll-behavior: none;
  }
  .wrap{max-width:1320px;margin:0 auto;padding:22px; padding-bottom: max(22px, env(safe-area-inset-bottom));}
  header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
  h1{font-size: clamp(18px, 2.6vw, 28px);margin:0}
  .sub{color:var(--sub);margin:2px 0 0 0;font-size:14px}
  main{display:grid;grid-template-columns: 1.15fr .85fr;gap:22px}
  @media (max-width: 1024px){
    main{grid-template-columns: 1fr;gap:14px}
  }
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .stage{display:grid;grid-template-rows:auto 1fr auto;gap:18px;min-height:520px}
  .machine{position:relative;height:min(56vh, 560px);display:grid;place-items:center;overflow:hidden;touch-action:manipulation}
  .drum{width:min(520px, 92%);aspect-ratio:1/1}
  .hex{transform-origin:50% 50%}
  .spin .hex{animation:roll 1.6s cubic-bezier(.2,.7,.2,1) forwards}
  @keyframes roll{0%{transform:rotate(0)}100%{transform:rotate(720deg)}}
  .crank{transform-origin: 165px 99px} /* pivot */
  .crank.grabbing #knob{filter:brightness(1.2)}
  .ball-slot{position:absolute;bottom:34px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px}
  .ball{width:72px;height:72px;border-radius:50%;border:3px solid #1112;background:#e5e7eb;
        box-shadow: inset 0 8px 12px rgba(255,255,255,.7), inset 0 -10px 14px rgba(0,0,0,.15), 0 10px 16px rgba(0,0,0,.08);
        display:grid;place-items:center;font-weight:800;color:#111c;transform:translateY(90px);opacity:0}
  .ball.show{animation:pop .5s ease-out forwards}
  @keyframes pop{0%{transform:translateY(90px) scale(.9);opacity:0}60%{transform:translateY(-6px) scale(1.04);opacity:1}100%{transform:translateY(0) scale(1);opacity:1}}
  .label{font-size:22px;font-weight:800;letter-spacing:.08em;padding:10px 16px;border-radius:14px;background:#111;color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.18);min-width:112px;text-align:center}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center}
  button,.btn{appearance:none;border:0;cursor:pointer;padding:16px 22px;border-radius:16px;font-weight:800;
              background:#111;color:#fff;transition:transform .04s ease,filter .2s ease;min-height:56px;font-size:18px}
  button:active{transform:translateY(1px)}
  .btn-ghost{background:#e5e7eb;color:#111}
  .btn-success{background:#16a34a}
  .odds{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px}
  .odds .row{display:flex;align-items:center;gap:10px;background:#f3f4f6;border-radius:14px;padding:12px 14px;font-size:18px}
  .chip{width:22px;height:22px;border-radius:50%;border:2px solid #1113;box-shadow: inset 0 3px 5px rgba(255,255,255,.7), inset 0 -3px 5px rgba(0,0,0,.2);flex:0 0 22px}
  .chip.white{background:#fafafa}.chip.blue{background:#3b82f6}.chip.red{background:#ef4444}.chip.yellow{background:#fbbf24}
  input[type="number"]{width:100%;padding:12px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:18px}
  .stats{display:grid;gap:12px}
  .statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .pill{display:grid;gap:8px;justify-items:center;padding:14px;border-radius:16px;background:#f3f4f6}
  .pill .count{font-size:28px;font-weight:900}
  .history{margin-top:8px;max-height:42vh;overflow:auto;border:1px dashed #e5e7eb;border-radius:14px;padding:12px;background:#fff}
  .history .item{display:flex;align-items:center;gap:12px;padding:12px 6px;border-bottom:1px solid #f3f4f6}
  .history .item:last-child{border-bottom:0}
  .time{color:#9ca3af;font-size:13px;margin-left:auto}
  #confetti{position:fixed;inset:0;pointer-events:none}
  .hint{display:block;margin-top:6px;color:#66707a;font-size:13px;text-align:center}
  #crankHit{cursor:grab}
  .grabbing #crankHit{cursor:grabbing}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="wrap">
  <header>
    <div>
      <h1>ã‚¬ãƒ©ã‚¬ãƒ©ç¦å¼•ãï½œiPad è½‰æŠŠæ‰‹ç‰ˆ</h1>
      <p class="sub">ç”¨æ‰‹æŒ‡æŠ“ä½æŠŠæ‰‹ã€Œè½‰ä¸€åœˆã€å°±æœƒå‡ºçƒã€‚ä¹Ÿå¯ä»¥é»ç•«é¢ä»»ä¸€è™•æŠ½ä¸€æ¬¡ã€‚</p>
    </div>
  </header>

  <main>
    <section class="card stage" aria-label="æŠ½é¸æ©Ÿ">
      <div class="machine" id="machine" title="æŠ“ä½æŠŠæ‰‹æ—‹è½‰è©¦è©¦çœ‹">
        <svg class="drum" id="drumSvg" viewBox="0 0 200 200" role="img" aria-label="ç¦å¼•ãæ©Ÿ">
          <defs>
            <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#f59e0b"/>
              <stop offset="1" stop-color="#b45309"/>
            </linearGradient>
            <linearGradient id="wood" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#d6b28a"/>
              <stop offset="1" stop-color="#a8825a"/>
            </linearGradient>
          </defs>
          <rect x="20" y="160" width="160" height="18" rx="6" fill="url(#wood)"/>
          <rect x="50" y="150" width="100" height="10" rx="4" fill="url(#wood)"/>
          <g class="hex" id="hex">
            <polygon points="100,35 145,55 165,100 145,145 100,165 55,145 35,100 55,55" fill="url(#g1)" stroke="#8b5a11" stroke-width="2"/>
            <polygon points="100,60 130,73 140,100 130,127 100,140 70,127 60,100 70,73" fill="#fde68a" opacity=".9" stroke="#b45309" stroke-width="1.5"/>
            <circle cx="100" cy="100" r="7" fill="#1f2937"/>
          </g>
          <!-- crank group (pivot around 165,99) -->
          <g class="crank" id="crank">
            <rect x="122" y="96" width="38" height="6" rx="3" fill="#374151"/>
            <circle id="knob" cx="165" cy="99" r="7" fill="#111"/>
            <circle cx="165" cy="99" r="4" fill="#e5e7eb"/>
            <!-- larger invisible hit area -->
            <circle id="crankHit" cx="165" cy="99" r="18" fill="transparent"/>
          </g>
          <rect x="92" y="138" width="16" height="22" rx="3" fill="#111"/>
          <rect x="84" y="156" width="32" height="8" rx="3" fill="#111"/>
        </svg>

        <div class="ball-slot" aria-live="polite">
          <div class="ball" id="ball"><span id="ballText">ï¼Ÿ</span></div>
          <div class="label" id="label">æŠ“ä½æŠŠæ‰‹è½‰å‹•</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="rollBtn" aria-label="æ–ä¸€ä¸‹">ğŸ² é»ä¸€ä¸‹æŠ½</button>
        <button class="btn btn-ghost" id="copyBtn" title="è¤‡è£½çµæœ">è¤‡è£½çµæœ</button>
        <button class="btn btn-success" id="resetBtn" title="é‡ç½®">é‡ç½®</button>
      </div>

      <div class="odds" aria-label="ä¸­çæ©Ÿç‡è¨­å®š">
        <div class="row"><span class="chip white"></span><label>ç™½ <input type="number" min="0" step="1" value="60" id="odds-white"></label></div>
        <div class="row"><span class="chip blue"></span><label>è— <input type="number" min="0" step="1" value="20" id="odds-blue"></label></div>
        <div class="row"><span class="chip red"></span><label>ç´… <input type="number" min="0" step="1" value="15" id="odds-red"></label></div>
        <div class="row"><span class="chip yellow"></span><label>é»ƒ <input type="number" min="0" step="1" value="5" id="odds-yellow"></label></div>
        <span class="hint">æç¤ºï¼šåŠ å…¥ä¸»ç•«é¢å¯å…¨è¢å¹•ï¼›æŠŠæ‰‹è½‰å¤ ä¸€åœˆï¼ˆç´„360Â°ï¼‰æœƒè‡ªå‹•å‡ºçƒã€‚</span>
      </div>
    </section>

    <aside class="card">
      <div class="stats">
        <div class="statgrid">
          <div class="pill"><div class="chip white"></div><div>ç™½</div><div class="count" id="c-white">0</div></div>
          <div class="pill"><div class="chip blue"></div><div>è—</div><div class="count" id="c-blue">0</div></div>
          <div class="pill"><div class="chip red"></div><div>ç´…</div><div class="count" id="c-red">0</div></div>
          <div class="pill"><div class="chip yellow"></div><div>é»ƒ</div><div class="count" id="c-yellow">0</div></div>
        </div>
        <div class="history" id="history"></div>
      </div>
    </aside>
  </main>
</div>

<canvas id="confetti"></canvas>

<script>
(function(){
  const rollBtn = document.getElementById('rollBtn');
  const copyBtn = document.getElementById('copyBtn');
  const resetBtn = document.getElementById('resetBtn');
  const machine = document.getElementById('machine');
  const ballEl = document.getElementById('ball');
  const labelEl = document.getElementById('label');
  const histEl = document.getElementById('history');
  const drumSvg = document.getElementById('drumSvg');
  const crank = document.getElementById('crank');
  const crankHit = document.getElementById('crankHit');
  const hex = document.getElementById('hex');

  const counters = {
    white: document.getElementById('c-white'),
    blue:  document.getElementById('c-blue'),
    red:   document.getElementById('c-red'),
    yellow:document.getElementById('c-yellow')
  };

  const oddsInputs = {
    white: document.getElementById('odds-white'),
    blue:  document.getElementById('odds-blue'),
    red:   document.getElementById('odds-red'),
    yellow:document.getElementById('odds-yellow')
  };

  const COLORS = {
    white: { zh:'ç™½', ja:'ç™½', css:'#fafafa', text:'#111', conf:'#e5e7eb' },
    blue:  { zh:'è—', ja:'é’', css:'#3b82f6', text:'#fff', conf:'#93c5fd' },
    red:   { zh:'ç´…', ja:'èµ¤', css:'#ef4444', text:'#fff', conf:'#fca5a5' },
    yellow:{ zh:'é»ƒ', ja:'é»„', css:'#fbbf24', text:'#111', conf:'#fde68a' }
  };

  let counts = {white:0, blue:0, red:0, yellow:0};
  let spinning = false;
  let lastResult = null;

  // Crank drag state
  let dragging = false;
  let lastAngle = 0;
  let accumDeg = 0;         // accumulated degrees since drag start
  const TRIGGER_DEG = 360;  // rotate roughly one full turn to trigger

  function now(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function readWeights(){
    const w = {
      white: Math.max(0, parseInt(oddsInputs.white.value||'0',10)),
      blue:  Math.max(0, parseInt(oddsInputs.blue.value ||'0',10)),
      red:   Math.max(0, parseInt(oddsInputs.red.value  ||'0',10)),
      yellow:Math.max(0, parseInt(oddsInputs.yellow.value||'0',10)),
    };
    const total = w.white + w.blue + w.red + w.yellow;
    return {w, total};
  }

  function weightedPick(){
    const {w, total} = readWeights();
    if(total <= 0){
      w.white=60; w.blue=20; w.red=15; w.yellow=5;
    }
    const t = w.white + w.blue + w.red + w.yellow;
    let r = Math.random() * t;
    if((r -= w.white) < 0) return 'white';
    if((r -= w.blue ) < 0) return 'blue';
    if((r -= w.red  ) < 0) return 'red';
    return 'yellow';
  }

  function setBall(colorKey){
    const c = COLORS[colorKey];
    ballEl.style.background = c.css;
    ballEl.style.color = c.text;
    ballEl.querySelector('#ballText').textContent = c.zh;
    labelEl.textContent = `ä¸­çï¼š${c.zh}ï¼ˆ${c.ja}ï¼‰`;
  }

  function addHistory(colorKey){
    const c = COLORS[colorKey];
    const div = document.createElement('div');
    div.className = 'item';
    const dot = document.createElement('span');
    dot.className = 'chip';
    dot.style.background = c.css; dot.style.borderColor = '#0002';
    const name = document.createElement('b');
    name.textContent = `${c.zh}`;
    const time = document.createElement('span');
    time.className = 'time';
    time.textContent = now();
    div.appendChild(dot); div.appendChild(name); div.appendChild(time);
    histEl.prepend(div);
  }

  function updateCounts(){
    counters.white.textContent = counts.white;
    counters.blue.textContent  = counts.blue;
    counters.red.textContent   = counts.red;
    counters.yellow.textContent= counts.yellow;
  }

  function confettiBurst(hexColor){
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio||1);
    function resize(){
      canvas.width = innerWidth * dpr;
      canvas.height = innerHeight * dpr;
      canvas.style.width = innerWidth + 'px';
      canvas.style.height = innerHeight + 'px';
    }
    resize();
    const particles = [];
    const N = 140;
    const colors = [hexColor, '#ffffff', '#111111', '#e5e7eb'];
    for(let i=0;i<N;i++){
      particles.push({
        x: canvas.width/2, y: canvas.height/2,
        vx: (Math.random()-0.5)*9*dpr,
        vy: (Math.random()-1.2)*7*dpr,
        g: 0.18*dpr,
        s: (6+Math.random()*8)*dpr,
        r: Math.random()*Math.PI*2,
        vr: (Math.random()-.5)*0.2,
        color: colors[Math.floor(Math.random()*colors.length)],
        life: 60 + Math.random()*40
      });
    }
    let tick=0, anim;
    function loop(){
      anim = requestAnimationFrame(loop);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.vy += p.g; p.r += p.vr; p.life -= 1;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.r);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
        ctx.restore();
      });
      tick++;
      if(tick>90){ cancelAnimationFrame(anim); ctx.clearRect(0,0,canvas.width,canvas.height); }
    }
    loop();
  }

  function roll(){
    if(spinning) return;
    spinning = true;
    machine.classList.add('spin');
    labelEl.textContent = 'æŠ½é¸ä¸­â€¦';
    ballEl.classList.remove('show');

    setTimeout(()=>{
      const color = weightedPick();
      lastResult = color;
      setBall(color);
      ballEl.classList.add('show');
      counts[color]++;
      updateCounts();
      addHistory(color);
      machine.classList.remove('spin');
      spinning = false;
      confettiBurst(COLORS[color].conf);
    }, 1400);
  }

  function resetAll(){
    counts = {white:0, blue:0, red:0, yellow:0};
    updateCounts();
    histEl.innerHTML='';
    labelEl.textContent='å·²é‡ç½®';
    lastResult = null;
    ballEl.classList.remove('show');
    ballEl.style.background = '#e5e7eb';
    ballEl.style.color = '#111c';
    ballEl.querySelector('#ballText').textContent = 'ï¼Ÿ';
  }

  function copyResult(){
    const {w} = readWeights();
    const weightInfo = `æ©Ÿç‡æ¬Šé‡ï¼ˆç™½/è—/ç´…/é»ƒï¼‰ï¼š${w.white}/${w.blue}/${w.red}/${w.yellow}`;
    const text = lastResult
      ? `ç¦å¼•çµæœï¼š${COLORS[lastResult].zh}ï¼ˆ${COLORS[lastResult].ja}ï¼‰ï½œ${weightInfo}`
      : `å°šæœªæŠ½é¸ã€‚${weightInfo}`;
    navigator.clipboard.writeText(text).then(()=>{
      labelEl.textContent = 'å·²è¤‡è£½çµæœ';
      setTimeout(()=>{ labelEl.textContent = lastResult? `ä¸­çï¼š${COLORS[lastResult].zh}` : 'æŠ“ä½æŠŠæ‰‹è½‰å‹•'; }, 900);
    }).catch(()=>{});
  }

  // ----- æŠŠæ‰‹æ‹–æ›³æ—‹è½‰ -----
  function getCenterOf(el){
    const rect = el.getBoundingClientRect();
    return { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
  }
  function angleFromCenter(center, clientX, clientY){
    return Math.atan2(clientY - center.y, clientX - center.x); // radians
  }
  function radToDeg(r){ return r * 180 / Math.PI; }
  function normDeltaDeg(deg){
    while(deg > 180) deg -= 360;
    while(deg < -180) deg += 360;
    return deg;
  }

  function startDrag(e){
    if(spinning) return;
    const pt = e.touches?.[0] || e;
    // only start if actually touching the knob hit area
    if(e.target !== crankHit) return;
    dragging = true;
    accumDeg = 0;
    const center = getCenterOf(crankHit);
    crank.dataset.cx = center.x;
    crank.dataset.cy = center.y;
    lastAngle = angleFromCenter(center, pt.clientX, pt.clientY);
    crank.classList.add('grabbing');
    try{ crankHit.setPointerCapture?.(e.pointerId); }catch(_){}
  }
  function moveDrag(e){
    if(!dragging) return;
    const pt = e.touches?.[0] || e;
    const cx = parseFloat(crank.dataset.cx), cy = parseFloat(crank.dataset.cy);
    const ang = angleFromCenter({x:cx, y:cy}, pt.clientX, pt.clientY);
    let delta = radToDeg(ang - lastAngle);
    delta = normDeltaDeg(delta);
    lastAngle = ang;
    accumDeg += delta;

    // visible crank wobble
    const clamp = Math.max(-30, Math.min(30, accumDeg % 60));
    crank.style.transform = `rotate(${clamp}deg)`;
    // subtle drum rotation
    hex.style.transform = `rotate(${(accumDeg*0.5)%360}deg)`;
    labelEl.textContent = `è½‰å‹•ä¸­â€¦ ${Math.floor(Math.abs(accumDeg))}Â°`;

    if(Math.abs(accumDeg) >= TRIGGER_DEG){
      endDrag();
      crank.style.transform = `rotate(0deg)`;
      machine.classList.add('spin');
      setTimeout(()=>{
        machine.classList.remove('spin');
        roll();
      }, 200);
    }
  }
  function endDrag(){
    if(!dragging) return;
    dragging = false;
    crank.classList.remove('grabbing');
    crank.style.transform = `rotate(0deg)`;
    hex.style.transform = `rotate(0deg)`;
    if(Math.abs(accumDeg) < TRIGGER_DEG){
      labelEl.textContent = 'å†å¤šè½‰ä¸€é»ï¼';
      setTimeout(()=>{ if(!spinning) labelEl.textContent = 'æŠ“ä½æŠŠæ‰‹è½‰å‹•'; }, 900);
    }
  }

  // ç¶å®šäº‹ä»¶ï¼ˆå„ªå…ˆä½¿ç”¨ Pointer Eventsï¼‰
  if(window.PointerEvent){
    crankHit.addEventListener('pointerdown', startDrag);
    window.addEventListener('pointermove', moveDrag);
    window.addEventListener('pointerup', endDrag);
    window.addEventListener('pointercancel', endDrag);
  }else{
    crankHit.addEventListener('touchstart', startDrag, {passive:false});
    window.addEventListener('touchmove', moveDrag, {passive:false});
    window.addEventListener('touchend', endDrag);
    crankHit.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup', endDrag);
  }

  // å‚™ç”¨æ“ä½œ
  rollBtn.addEventListener('click', ()=>{ if(!spinning) roll(); });
  machine.addEventListener('click', (e)=>{
    if(e.target.id === 'crankHit' || e.target.id === 'knob') return; // é¿å…æ‹–æ‹½æ™‚èª¤è§¸
    if(!spinning) roll();
  });
  copyBtn.addEventListener('click', copyResult);
  resetBtn.addEventListener('click', resetAll);

  // éµç›¤ï¼ˆå¤–æ¥éµç›¤ï¼‰
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){ e.preventDefault(); if(!spinning) roll(); }
    else if(e.key.toLowerCase() === 'r'){ resetAll(); }
    else if(e.key.toLowerCase() === 'c'){ copyResult(); }
  }, {passive:false});

  // æ¬Šé‡è¼¸å…¥æ ¼å¼æ•´ç†
  Object.values(oddsInputs).forEach(inp=>{
    inp.addEventListener('input', ()=>{
      if(inp.value === '') return;
      const v = Math.max(0, Math.round(Number(inp.value)||0));
      inp.value = String(v);
    });
  });

  // åˆå§‹
  updateCounts();
})();
</script>
</body>
</html>